version: "3.9"
services:

  frontenvoy:
    image: envoyproxy/envoy:v1.16.2
    volumes:
      - ./front/envoy.yaml:/etc/envoy/envoy.yaml
      - /etc/letsencrypt/live/esm-api.aadi.my-0001/fullchain.pem:/etc/envoy/certs/fullchain.pem
      - /etc/letsencrypt/live/esm-api.aadi.my-0001/privkey.pem:/etc/envoy/certs/privkey.pem
    restart: always
    environment: 
      - ENVOY_UID=0
      - ENVOY_GID=0
    networks:
      - envoymesh
    expose:
      - "443"
    ports:
      - "443:443"

  grpc-web-proxy:
    image: envoyproxy/envoy:v1.16.2
    volumes:
      - ./grpc_web_proxy/envoy.yaml:/etc/envoy/envoy.yaml
    restart: always
    environment: 
      - ENVOY_UID=0
      - ENVOY_GID=0
    networks:
      - envoymesh
    depends_on:
      - "esmservice"
    links:
      - "esmservice"
    expose:
      - "8080"
    ports: 
      - "8080:8080"

  esmservice:
    build:
      context: .
      dockerfile: ./service/Dockerfile
    restart: always
    environment:
      LISTEN_ON: 0.0.0.0:50051
      BEFORE_LOGIN_TOKEN: Bearer before-login-token
      STRIPE_SECRET: sk_test_51IOa7gBGCaV2oEVpEDw9fOn1fUn8IaPOemu7Yjkg6N75C3ahsd7sEQr3ait4JYU55wfCBbXCRPIhcUxGMVtQYA6A003YKMqkYF
      CHECKER_TIME_WAIT: 60
      FCM_KEY: AAAAzT8d8lM:APA91bHtFSHVIBiiSDUWSaUkrYNrcBSyhMY_JBYSeaaoWpkrxSgBO-7xgHtySH3qfTvsgHHTIsrh_SwwirCvTTuOWBl0--JhddEV8MFnEgWuGRPOXPVyTBHym5k9gh8WrCxr-rY13Y54
      JWK_URL: https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com
      JWK_AUDIENCE: esports-mini
      JWK_ISSUER: https://securetoken.google.com/esports-mini
      DB_CONN_STRING: postgresql://doadmin:tf45h3hpz6xstby6@dbpg-master:25432/postgres?sslmode=require
      SERVER_TIMEZONE: 8
    depends_on:
      - "dbpg-master"
    links:
      - "dbpg-master"
    networks:
      - envoymesh
    expose:
      - "50051"
    ports:
      - "50051:50051"

  esm-game-loader:
    build:
      context: .
      dockerfile: ./gloader/Dockerfile
    restart: always
    environment:
      LISTEN_ON: 0.0.0.0:3033
      JWK_URL: https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com
      JWK_AUDIENCE: esports-mini
      JWK_ISSUER: https://securetoken.google.com/esports-mini
      DB_CONN_STRING: postgresql://doadmin:tf45h3hpz6xstby6@dbpg-master:25432/postgres?sslmode=require
      SERVER_TIMEZONE: 8
    networks:
      - envoymesh
    expose:
      - "3033"
    ports:
      - "3033:3033"

  esm-admin:
    build:
      context: .
      dockerfile: ./admin/Dockerfile
    restart: always
    environment:
      LISTEN_ON: 0.0.0.0:3030
    networks:
      - envoymesh
    expose:
      - "3030"
    ports:
      - "3030:3030"
      
  esm-stripe:
    build:
      context: .
      dockerfile: ./stripe/Dockerfile
    restart: always
    environment:
      PORT: 4242
      STRIPE_SECRET: sk_test_51IOa7gBGCaV2oEVpEDw9fOn1fUn8IaPOemu7Yjkg6N75C3ahsd7sEQr3ait4JYU55wfCBbXCRPIhcUxGMVtQYA6A003YKMqkYF
    networks:
      - envoymesh
    expose:
      - "4242"
    ports:
      - "4242:4242"

volumes:
networks:
  envoymesh: {}